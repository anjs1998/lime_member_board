<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.example.project.board.model.mapper.BoardMapper">
   
  <!-- =========================================================
      ResultMap : MyBatis에서 제공하는 sql문 dto 객체 매핑규칙
      
      Write DTO와 연결되는 resultMap임.
       ========================================================= -->
  <resultMap id="writeMap" type="com.example.project.board.model.dto.Write">
    <id     property="postId"      column="POST_ID"/>
    <result property="postTitle"   column="POST_TITLE"/>
    <result property="postContent" column="POST_CONTENT"/>
    <result property="postDate"    column="POST_DATE"/>
    <result property="memberId"    column="MEMBER_ID"/>
    <result property="deletedAt"   column="DELETED_AT"/>
  </resultMap>
  
  <resultMap id="writeFileMap" type="com.example.project.board.model.dto.WriteFile">
	<id property="fileId" column="FILE_ID"/>
    <result property="postId" column="POST_ID"/>
    <result property="path" column="PATH"/>
    <result property="fileNameOriginal" column="FILE_NAME_ORIGINAL"/>
    <result property="fileNameSaved" column="FILE_NAME_SAVED"/>
    <result property="dateSaved" column="DATE_SAVED"/>
  </resultMap>
	<!-- 게시글 수 조회 -->
	<select id="getListCount">
		SELECT COUNT(*)
		FROM "WRITE" W
		LEFT JOIN MEMBER M ON W.MEMBER_ID = M.MEMBER_ID<!-- OUTER로 이미 존재하지 않는 MEMBER_ID까지 조회할수 있도록.-->
		WHERE W.DELETED_AT IS NULL
	</select>
  <!-- 게시글 전체 조회 (삭제되지 않은 글만)
       - 최신글이 위로 오도록 정렬
  -->
  <select id="selectWriteList" resultMap="writeMap">
    SELECT POST_ID
         , POST_TITLE
         , POST_CONTENT
         , POST_DATE
         , MEMBER_ID
         , DELETED_AT
      FROM "WRITE"
     WHERE DELETED_AT IS NULL
  ORDER BY POST_DATE DESC
  </select>
    <!-- 게시글 등록
       - POST_ID: 시퀀스 사용 가정 (SEQ_POST_ID.NEXTVAL)
       - POST_DATE: SYSDATE
  -->
  	<select id="selectWriteById" resultType="com.example.project.board.model.dto.Write">
  	SELECT
      POST_ID,
      POST_TITLE,
      POST_CONTENT,
      POST_DATE,
      MEMBER_ID,
      DELETED_AT
    FROM "WRITE"
    WHERE POST_ID = #{writeId}
    AND DELETED_AT IS NULL
  	</select>
  	
    <insert id="insertWrite" parameterType="com.example.project.board.model.dto.Write">
    		<selectKey keyProperty="postId" 
    		resultType="long"
    		 order="BEFORE"><!-- selectKey : 아래 SQL문 실행 전에 여기 안의 SQL문 먼저 실행후 값을 dto안에 집어넣는 특별한 문구-->
    		 <!-- keyProperty : select된 결과값을 postId에 집어넣음.-->
    		 <!--resultType : -->
    		 <!--order : "BEFORE" 아래 SQL문 실행전 이걸 실행하도록 한다.-->
		  SELECT SEQ_POST_ID.NEXTVAL FROM DUAL
		</selectKey>
    
	    INSERT INTO "WRITE"
	         ( POST_ID
	         , POST_TITLE,
	      POST_CONTENT,
	      POST_DATE,
	      MEMBER_ID
	         )
	    VALUES
	         (
	      #{postId}  ,
	      #{postTitle},
	      #{postContent},
	      SYSDATE,
	      #{memberId}
	         )
  </insert>
  
  
  <select id="selectFiles" parameterType = "long" resultMap = "writeFileMap">
  
  	    SELECT
        FILE_ID,
        POST_ID,
        PATH,
        FILE_NAME_ORIGINAL,
        FILE_NAME_SAVED,
        DATE_SAVED
    FROM WRITE_FILE
    WHERE POST_ID = #{postId}
  </select>
  <!--파일 등록.-->
  <insert id="insertFiles"
	        parameterType="java.util.List">
	    
	    INSERT INTO WRITE_FILE
	    (
	        FILE_ID,
	        POST_ID,
	        PATH,
	        FILE_NAME_ORIGINAL,
	        FILE_NAME_SAVED,
	        DATE_SAVED
	    )  
	    VALUES
	    <foreach collection="uploadList" item="f" separator=",">
    			(SEQ_FILE_ID.NEXTVAL, #{postId}, #{f.path}, #{f.fileNameOriginal}, #{f.fileNameSaved}, SYSDATE)
  		</foreach>
	</insert> 
  <!-- 게시글 수정 (삭제되지 않은 글만)
       - 수정 시점 기록 컬럼이 없어서 POST_DATE는 건드리지 않음
  -->
  <update id="updateWrite" parameterType="com.example.project.board.model.dto.Write">
    UPDATE "WRITE"
    SET
      POST_TITLE   = #{postTitle},
      POST_CONTENT = #{postContent}
    WHERE POST_ID = #{postId}
      AND DELETED_AT IS NULL
  </update>
   
  <!-- 게시글 소프트 삭제 -->
  <update id="deleteWriteById" parameterType="long">
    UPDATE "WRITE"
    SET
      DELETED_AT = SYSDATE
    WHERE POST_ID = #{postId}
      AND DELETED_AT IS NULL
  </update>
   
   <!-- 삭제할 파일 메타 조회 -->
	<select id="selectFilesByPostIdAndFileIds"
	        resultType="com.example.project.board.model.dto.WriteFile">
	
	    SELECT
	        FILE_ID            AS fileId,
	        POST_ID            AS postId,
	        PATH               AS path,
	        FILE_NAME_ORIGINAL AS fileNameOriginal,
	        FILE_NAME_SAVED    AS fileNameSaved,
	        DATE_SAVED         AS dateSaved
	    FROM WRITE_FILE
	    WHERE POST_ID = #{postId}
	      AND FILE_ID IN
	    <foreach collection="fileIds" item="id" open="(" separator="," close=")">
	        #{id}
	    </foreach>
	</select>
	<delete id="deleteFilesByPostIdAndFileIds">
	  DELETE FROM WRITE_FILE
	  WHERE POST_ID = #{postId}
	    AND FILE_ID IN
	    <foreach collection="fileIds" item="id" open="(" separator="," close=")">
	      #{id}
	    </foreach>
	</delete>
	   
</mapper>