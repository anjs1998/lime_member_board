<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.example.project.board.model.mapper.CommentMapper">

    <!-- 댓글 단일 조회 -->
    <select id="selectCommentById"
            parameterType="long"
            resultType="map">
        SELECT
            c.COMMENT_ID           AS "commentId"
            , c.COMMENT_TIME         AS "commentTime"
            , c.POST_ID              AS "postId"
            , c.PARENT_COMMENT_ID    AS "parentCommentId"
            , c.COMMENT_CONTENT      AS "commentContent"
            , c.DELETED_AT           AS "deletedAt"
            , c.MEMBER_ID            AS "memberId"
            , m.MEMBER_NICKNAME      AS "memberNickname"
        FROM "COMMENT" c
        JOIN MEMBER m
          ON c.MEMBER_ID = m.MEMBER_ID
        WHERE c.COMMENT_ID = #{commentId}
          AND c.DELETED_AT IS NULL
    </select>
	<select id="selectCommentsByPostId"
        parameterType="long"
        resultType="map">
			           SELECT  	c.COMMENT_ID         AS "commentId"
    							, c.COMMENT_TIME       AS "commentTime"
    							, c.POST_ID            AS "postId"
    							, c.PARENT_COMMENT_ID  AS "parentCommentId"
    							, c.COMMENT_CONTENT    AS "commentContent"
    							
    							, CASE
						            WHEN c.DELETED_AT IS NOT NULL
						            THEN NULL
						            ELSE c.COMMENT_CONTENT
						          END                 AS "commentContent"
						          
    							, c.MEMBER_ID          AS "memberId"
    							, LEVEL                AS "depth"
			  					, m.MEMBER_NICKNAME    AS "memberNickname"
  			             FROM 	"COMMENT" c
  					LEFT JOIN	MEMBER m ON c.MEMBER_ID=m.MEMBER_ID
  						WHERE 	c.POST_ID = #{postId}
    							--AND c.DELETED_AT IS NULL--
    					
    				START WITH	c.PARENT_COMMENT_ID IS NULL
    				
    				CONNECT BY 	NOCYCLE PRIOR c.COMMENT_ID = c.PARENT_COMMENT_ID
    				
    		 ORDER SIBLINGS BY	c.COMMENT_TIME ASC, c.COMMENT_ID ASC	
	</select>
    <!-- 댓글 등록 -->
    <insert id="insertComment"
            parameterType="com.example.project.board.model.dto.Comment">
            
                <!-- 1️⃣ INSERT 전에 시퀀스 값 뽑기. -->
	    <selectKey keyProperty="commentId"
	               resultType="long"
	               order="BEFORE">
	        SELECT SEQ_COMMENT_ID.NEXTVAL FROM DUAL
	    </selectKey>

        INSERT INTO "COMMENT" (
            COMMENT_ID,
            COMMENT_TIME,
            POST_ID,
            PARENT_COMMENT_ID,
            COMMENT_CONTENT,
            MEMBER_ID
        )
        VALUES (
            #{commentId},
            SYSDATE,
            #{postId},
            #{parentCommentId, jdbcType=NUMERIC},
            #{commentContent},
            #{memberId}
        )
    </insert>

    <!-- 댓글 수정 -->
    <update id="modifyComment">
        UPDATE "COMMENT"
        SET COMMENT_CONTENT = #{content}
        WHERE COMMENT_ID = #{commentId}
          AND DELETED_AT IS NULL
    </update>

    <!-- 댓글 삭제 (소프트 삭제) -->
    <update id="deleteComment"
            parameterType="long">
        UPDATE "COMMENT"
        SET DELETED_AT = SYSDATE
        WHERE COMMENT_ID = #{commentId}
    </update>
	<select id="selectCommentWriter" parameterType="long">
		SELECT MEMBER_ID FROM "COMMENT" WHERE COMMENT_ID = #{commentId}
	</select>
</mapper>